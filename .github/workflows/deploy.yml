name: Production Deploy (Trafic-Legal)

on:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64, prod]

    steps:
      # 1. Eski papkani tozalash (Agar mavjud bo'lsa)
      - name: Clean up old project directory
        run: |
          # Agent turgan joyda 'trafic-legal' bo'lsa, uni butunlay o'chirib tashlaymiz
          # Bu loyihani noldan (Fresh) yuklanishini ta'minlaydi
          if [ -d "trafic-legal" ]; then
            echo "Eski papka topildi, o'chirilmoqda..."
            rm -rf trafic-legal
          else
            echo "Eski papka topilmadi, yangi yaratiladi."
          fi

      # 2. Kodni noldan yuklab olish
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: trafic-legal

      # 3. Docker Deploy
      - name: Deploy with Docker Compose
        run: |
          cd trafic-legal

          # Docker-ni toza holda ko'tarish
          # --force-recreate bayrog'i konteynerni yangidan yaratishga majbur qiladi
          docker compose up -d --build --force-recreate

          # Keraksiz va 'osilib' qolgan obrazlarni tozalash
          docker image prune -f

      - name: Status Check
        run: |
          cd trafic-legal
          docker compose ps
